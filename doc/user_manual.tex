\documentclass{article}

\usepackage{xcolor}

\newcommand{\eq}[1]{(\ref{#1})}

\newcommand{\code}[1]{\texttt{#1}}
\newcommand{\class}[1]{\colorbox{blue!30}{\code{#1}}}

\newcommand{\ns}{n_{\mathrm{s}}}
\newcommand{\nsj}{n_{\mathrm{s},j}}
\newcommand{\ps}{\vec{p}_{\mathrm{s}}}
\newcommand{\psk}{\vec{p}_{\mathrm{s},k}}
\newcommand{\xs}{\vec{x}_{\mathrm{s}}}
\newcommand{\xsk}{\vec{x}_{\mathrm{s},k}}

\newcommand{\dPhisdE}{\frac{\mathrm{d}\Phi_{\mathrm{s}}}{\mathrm{d}E}}


\begin{document}

\section{The Likelihood Formalism}

This section describes the mathematical likelihood formalism used in Skylab.
First it introduces the log-likelihood approach, second the likelihood ratio
test and the used test statistic and then describes the used optimizations.

\subsection{The Log-Likelihood Approach}

Skylab implements the two-component likelihood approach with a likelihood
function $\mathcal{L}(n_{\mathrm{s}},\vec{p}_{\mathrm{s}}~|D)$ of the form
\begin{equation}
 \mathcal{L}(\ns,\ps~|D) = \prod_{i=1}^{N}\left[ \frac{\ns}{N} \mathcal{S}_{i}(\ps) + (1 - \frac{\ns}{N}) \mathcal{B}_{i} \right],
\label{eq:L}
\end{equation}
where $\ns$ is the number of signal events, hence, $(N-\ns)$ the number of
background events in the dataset $D$ of $N$ total events.
The set of signal model parameters is denoted as $\ps$. For a point-like source
model, the signal model parameters include the source position $\xs$ and the
spectral index $\gamma$ of the source flux.
$\mathcal{S}_i(\ps)$ and $\mathcal{B}_i$ is the value of the signal and background PDF for the $i$th data
event, respectively.

The signal and background PDFs must incorperate the detector efficiency (yield),
$\mathcal{Y}_i$, which, in general, depends on the celestrial direction, the
energy, and the observation time of the data event.

For computational stability reasons the logarithm of the likelihood function of
equation \ref{eq:L} is used in Skylab:
\begin{equation}
 \log \mathcal{L}(\ns,\ps~|D) = \sum_{i=1}^{N} \log (...)
\end{equation}

\subsection{Likelihood Ratio Test and Test Statistic}

For estimating the significance of an observation, the likelihood ratio
$\Lambda$ with respect to a null hypothesis of no observation, i.e.
equation \ref{eq:L} at $\ns=0$ is tested:
\begin{equation}
 \log \Lambda(\ns,\ps) = \log \frac{L(\ns,\ps)}{L(\ns=0)} = \sum_{i=1}^{N} \log \left[ 1 + \frac{\ns}{N}\left( \frac{\mathcal{S}_i(\ps)}{\mathcal{B}_i} - 1 \right) \right]
\label{eq:logLambda}
\end{equation}
By defining
\begin{equation}
\mathcal{X}_i(\ps) \equiv \frac{1}{N}\left( \mathcal{R}_i(\ps) - 1 \right),
\label{eq:Xi}
\end{equation}
with
\begin{equation}
 \mathcal{R}_i(\ps) \equiv \frac{\mathcal{S}_i(\ps)}{\mathcal{B}_i},
\end{equation}
this reads as:
\begin{equation}
 \log \Lambda(\ns,\ps) = \sum_{i=1}^{N} \log (1 + \ns\mathcal{X}_i(\ps)).
 \label{eq:logLambdaOfX}
\end{equation}
The $\mathcal{R}_{i}(\ps)$ is the signal over background PDF ratio value of the
$i$th event.

Using Wilks theorem a test statistic, TS, can be formulated using the
log-$\Lambda$ function:
\begin{equation}
 \mathrm{TS} = 2\mathrm{sgn}(\ns) \log \Lambda(\ns,\ps)
 \label{eq:TS}
\end{equation}
with separation of over- ($\ns > 0$) and under-fluctuations ($\ns < 0$).
In case the assumptions of Wilks theorem are met within the analysis, the test
statistic value distribution will follow a $\chi^2$-distribution with
a degree-of-freedom equal to the number of fit parameters.

\subsection{Optimizations for Point-Like Sources}

For point-source like signal hypotheses most of the events in the data sample
will be far away from the hypothesised source, hence, the value of the
signal PDF $\mathcal{S}_i$ will be zero or very close to zero. By selecting only
the signal-contributing $N'$ events from the sample, the likelihood ratio
$\log \Lambda$ reads
\begin{equation}
 \log \Lambda(\ns,\ps) = \sum_{i=1}^{N'} \log(1 + \ns\mathcal{X}_i(\ps)) + (N - N')\log(1 - \frac{\ns}{N})
 \label{eq:logLambdaOfXOptimized}
\end{equation}


\subsection{Signal \& Background PDFs}

The likelihood ratio function as given in equation \eq{eq:logLambda}
incorperates signal, $\mathcal{S}_i$, and background, $\mathcal{B}_i$,
probability density functions (PDFs). Both PDFs can be factorized into a
spatial ($S_i$), an energy ($\mathcal{E}_i$), and a time ($\mathcal{T}_i$)
component.

The signal PDF can be written as
\begin{equation}
 \mathcal{S}_i(\ps) \equiv S_{\mathcal{S}}(\vec{x}_i|\vec{p}_{\mathrm{s,spatial}}) \mathcal{E}_{\mathcal{S}}(E_i|\vec{p}_{\mathrm{s,energy}}) \mathcal{T}_{\mathcal{S}}(t_i|\vec{p}_{\mathrm{s,time}}),
 \label{eq:Si}
\end{equation}
where the signal model parameters $\ps$ can be divided into spatial, energy, and
time parameters, i.e. $\vec{p}_{\mathrm{s}} = (\vec{p}_{\mathrm{s,spatial}},
\vec{p}_{\mathrm{s,energy}}, \vec{p}_{\mathrm{s,time}})$. The spatial component,
$S_{\mathcal{S}}$, can be identified as the convolution,
$(\Psi \ast \mathrm{PSF})(\alpha,\delta)$\footnote{The 2D convolution on the sky
is defined as
$(f \ast g)(\alpha,\delta) = \int_{0}^{2\pi} \mathrm{d}\alpha' \int_{-\pi}^{\pi} \mathrm{d}\delta' f(\alpha',\delta')g(\alpha-\alpha',\delta-\delta')$.},
of the spatial source extension, $\Psi(\alpha,\delta)$, and the point-spread-function,
$\mathrm{PSF}(\alpha,\delta)$, of the detector.
For a point-like spatial source extension at position
$\xs = (\alpha_{\mathrm{s}},\delta_{\mathrm{s}})$, that is
$\Psi(\alpha,\delta) = \delta(\alpha-\alpha_{\mathrm{s}})\delta(\delta-\delta_{\mathrm{s}})$,
where $\delta(\cdot)$ is the delta-distribution, this convolution collapses to
a single point in the sky. With a 2D gaussian PSF
$S_{\mathcal{S}}(\vec{x}_i|\vec{p}_{\mathrm{s,spatial}})$ is given as
\begin{equation}
 S_{\mathcal{S}}(\vec{x}_i|\vec{p}_{\mathrm{s,spatial}}) \equiv S_{\mathcal{S}}(r_i,\sigma_i|\xs) = \frac{1}{2\pi\sigma_i^2}\exp\left({-\frac{r_i^2}{2\sigma_i^2}}\right),
\end{equation}
where $r_i$ is the space angle between the source position and the recorded
reconstructed event direction. In equatorial coordinates,
$\vec{x} = (\alpha,\delta)$, the cosine of $r_i$ is given by
\begin{equation}
 \cos(r_i) = \cos(\alpha_{\mathrm{s}} - \alpha_i) \cos(\delta_{\mathrm{s}})\cos({\delta_i}) + \sin(\delta_{\mathrm{s}})\sin(\delta_i).
\end{equation}
The data quantity $\sigma_i$ describes the angular reconstruction uncertainty of
the event, hence the PSF is narrower for well-reconstructed events, and wider
for events which have a large reconstruction uncertainty.

When considering a power law as source flux model, the energy source parameters,
$\vec{p}_{\mathrm{s,energy}}$, consists of the spectral index $\gamma$ and possibly
an energy cut-off parameter $E_{\mathrm{cut}}$.

In analog to the signal PDF, the background PDF can be formulated as
\begin{equation}
 \mathcal{B}_i \equiv S_{\mathcal{B}}(\vec{x}_i) \mathcal{E}_{\mathcal{B}}(E_i) \mathcal{T}_{\mathcal{B}}(t_i).
 \label{eq:Bi}
\end{equation}
All the background PDF components can either be determined from the data itself
or by using monte-carlo simulation.

\subsubsection{Notes on the energy PDFs}

In general, the energy PDFs are detector response dependent. That means they
depend on the local direction of the detected events. Hence, the spatial and
energy PDFs cannot be factorized entirely in space and energy.

For IceCube the energy resolution mostly depends on the zenith angle, and hence
on the declination, of the event. Thus, several energy PDFs are created for a
set of (reconstructed) declination bands, both, for signal and background. At
the data evaluation, the signal and background PDFs are selected corresponding
to the declination band the event's declination is part of. Hence, for IceCube,
the signal and background energy PDFs can be formulated as
$\mathcal{E}_{\mathcal{S}}(E|\vec{p}_{\mathrm{s,energy}},\delta)$ and
$\mathcal{E}_{\mathcal{B}}(E|\delta)$, respectively.

A lengthly discussion has been conducted in the past to clarify whether the true or
reconstructed direction of the monte-carlo events should be used to generate
the several signal energy PDFs. Since, we mainly use experimental data as
background estimation it as been concluded to use the reconstructed event
direction in order to be consistent in the data evaluation for signal and
background PDFs.

\subsection{Stacking of Sources}

In general a likelihood value can be calculated for a set of $K$ stacked
sources in a weighted fassion. In this case the signal PDF expression of
equation (\ref{eq:Si}) becames a bit more complicated due to the relative
source weighting. The sources must be weighted according to their signal detection
efficiency, $\mathcal{Y}_{\mathrm{s},k}$, and a relative strength weight of the
sources, $W_k$, with $\sum_{k=1}^{K} W_k = 1$. Hence, the combined signal PDF is
given as
\begin{equation}
 \mathcal{S}_i(\ps) \equiv \frac{\sum_{k=1}^{K} W_k \mathcal{Y}_{\mathrm{s}}(\xsk,\psk) \mathcal{S}_{i}(\psk)}{\sum_{k=1}^{K}W_k\mathcal{Y}_{\mathrm{s}}(\xsk,\psk)}.
 \label{eq:SiStacking}
\end{equation}
One should note that this formalism allows for different source properties, e.g.
energy spectra, for the various sources.


\subsection{Gradients of the Log-Likelihood Ratio}

For maximizing the log-likelihood ratio function (equation \ref{eq:logLambdaOfX}),
or minimizing the negative of it, the minimizer algorithm requires the
derivatives of the log-likelihood ratio function w.r.t. the fit parameters, $\ps$\footnote{In this formalism we assume that $\ps$
consists solely of fit parameters for the signal, but in practice it can also consist of fixed
signal parameters.}. Hence, here we provide the expressions of the derivatives
for equation \ref{eq:logLambdaOfXOptimized}.
The derivative w.r.t. $\ns$ is given by
\begin{equation}
\frac{\mathrm{d} \log \Lambda(\ns,\ps)}{\mathrm{d} \ns} = \sum_{i=1}^{N'} \frac{\mathcal{X}_i(\ps)}{1+\ns \mathcal{X}_i(\ps)} - \frac{N - N'}{N - \ns}.
\end{equation}
The derivative w.r.t. an individual signal parameter, $p_{\mathrm{s}}$,
is given by
\begin{equation}
 \frac{\mathrm{d} \log \Lambda(\ns,\ps)}{\mathrm{d} p_{\mathrm{s}}} = \sum_{i=1}^{N'} \frac{\ns}{1+\ns\mathcal{X}_i(\ps)} \frac{\mathrm{d} \mathcal{X}_i(\ps)}{\mathrm{d} p_{\mathrm{s}}}.
\end{equation}
The derivative of $\mathcal{X}_i$ can be calculated using
equation \ref{eq:Xi} and the expressions for the signal and background PDFs as given
in equation \ref{eq:Si} and \ref{eq:Bi}, respectively. Depending on the type of
fit parameter, i.e. spatial, energy, or time, the derivative of the PDF ratio,
$\mathcal{R}_i(\ps) = \mathcal{S}_i(\ps) / \mathcal{B}_i$, simplifies to the
derivative of the respective type of PDF ratio:
\begin{equation}
 \frac{\mathrm{d} \mathcal{X}_i(\ps)}{\mathrm{d} p_{\mathrm{s}}} = \frac{1}{N}\frac{\mathrm{d} \mathcal{R}_i(\ps)}{\mathrm{d} p_{\mathrm{s}}},
\end{equation}
with
\begin{equation}
 \mathcal{R}_i(\ps) = \mathcal{R}_{S,i}(\vec{p}_{s,\mathrm{spatial}}) \mathcal{R}_{\mathcal{E},i}(\vec{p}_{s,\mathrm{energy}}) \mathcal{R}_{\mathcal{T},i}(\vec{p}_{s,\mathrm{time}}),
 \label{eq:Ri}
\end{equation}
and
\begin{equation}
 \frac{\mathrm{d} \mathcal{R}_i(\ps)}{\mathrm{d} p_{\mathrm{s,spatial}}} = \frac{\mathrm{d} \mathcal{R}_{S,i}(\vec{p}_{s,\mathrm{spatial}})}{\mathrm{d} p_{\mathrm{s,spatial}}} \mathcal{R}_{\mathcal{E},i}(\vec{p}_{s,\mathrm{energy}}) \mathcal{R}_{\mathcal{T},i}(\vec{p}_{s,\mathrm{time}}),
\end{equation}
\begin{equation}
 \frac{\mathrm{d} \mathcal{R}_i(\ps)}{\mathrm{d} p_{\mathrm{s,energy}}} = \mathcal{R}_{S,i}(\vec{p}_{s,\mathrm{spatial}}) \frac{\mathrm{d} \mathcal{R}_{\mathcal{E},i}(\vec{p}_{s,\mathrm{energy}})}{\mathrm{d} p_{\mathrm{s,energy}}} \mathcal{R}_{\mathcal{T},i}(\vec{p}_{s,\mathrm{time}}),
\end{equation}
\begin{equation}
 \frac{\mathrm{d} \mathcal{R}_i(\ps)}{\mathrm{d} p_{\mathrm{s,time}}} = \mathcal{R}_{S,i}(\vec{p}_{s,\mathrm{spatial}}) \mathcal{R}_{\mathcal{E},i}(\vec{p}_{s,\mathrm{energy}}) \frac{\mathrm{d} \mathcal{R}_{\mathcal{T},i}(\vec{p}_{s,\mathrm{time}})}{\mathrm{d} p_{\mathrm{s,time}}}.
\end{equation}

For stacked sources the expression for $\mathcal{R}_i(\ps)$ in equation (\ref{eq:Ri})
becomes slightly more complicated due to the source strength weighting.
With equation (\ref{eq:SiStacking}) and the definitions
\begin{equation}
 a_k(\xsk,\psk) = W_k\mathcal{Y}_{\mathrm{s}}(\xsk,\psk),
\end{equation}
and
\begin{equation}
 A(\ps) = \sum_{k=1}^{K} a_k(\xsk,\psk),
\end{equation}
it is given by
\begin{equation}
\mathcal{R}_i(\ps) = \frac{\mathcal{S}_i(\ps)}{\mathcal{B}_i} = \frac{1}{A(\ps)} \sum_{k=1}^{K} a_k(\xsk,\psk) \frac{\mathcal{S}_{i}(\psk)}{\mathcal{B}_{i}}.
\label{eq:RiStacking}
\end{equation}
The signal over background ratio $\mathcal{S}_{i}(\psk) / \mathcal{B}_{i} \equiv \mathcal{R}_{k,i}(\psk)$
for the single source $k$ is then given by equation (\ref{eq:Ri}).

Using the same set of source fit parameters $\ps$ for all sources, i.e. called
global source fit parameters, the derivative of $\mathcal{R}_i(\ps)$ for
all stacked sources w.r.t. the single global source fit parameter,
$p_{\mathrm{s}}$, is then given by
\begin{equation}
 \frac{\mathrm{d} \mathcal{R}_{i}(\ps)}{\mathrm{d} p_{\mathrm{s}}} = - \frac{1}{A^2} \frac{\mathrm{d} A}{\mathrm{d} p_{\mathrm{s}}} \sum_{k=1}^{K} a_{k} \mathcal{R}_{k,i}(\psk) + \frac{1}{A}\sum_{k=1}^{K} \left( \frac{\mathrm{d} a_{k}}{\mathrm{d} p_{\mathrm{s}}}\mathcal{R}_{k,i}(\psk) + a_{k}\frac{\mathrm{d} \mathcal{R}_{k,i}(\psk)}{\mathrm{d} p_{\mathrm{s}}} \right).
\end{equation}
Using $\mathcal{R}_i(\ps)$ from equation (\ref{eq:RiStacking}) it simplifies to
\begin{equation}
 \frac{\mathrm{d} \mathcal{R}_{i}(\ps)}{\mathrm{d} p_{\mathrm{s}}} = \frac{1}{A(\ps)}\left[ -\mathcal{R}_i(\ps)\frac{\mathrm{d} A}{\mathrm{d} p_{\mathrm{s}}} + \sum_{k=1}^{K} \left( \frac{\mathrm{d} a_{k}}{\mathrm{d} p_{\mathrm{s}}}\mathcal{R}_{k,i}(\psk) + a_{k}\frac{\mathrm{d} \mathcal{R}_{k,i}(\psk)}{\mathrm{d} p_{\mathrm{s}}} \right) \right],
 \label{eq:gradRi}
\end{equation}
with the derivative of $A(\ps)$ given by
\begin{equation}
 \frac{\mathrm{d} A}{\mathrm{d} p_{\mathrm{s}}} = \sum_{k=1}^{K} \frac{\mathrm{d} a_k}{\mathrm{d} p_{\mathrm{s}}}.
\end{equation}

In case one would fit each source individually with its own set of signal fit
parameters, $\vec{p}_{\mathrm{s},k}$, $\ps$ would be a set of $K$ sets
of source fit parameters $\vec{p}_{\mathrm{s},k}$, and a derivative for each
individual source fit parameter $p_{\mathrm{s},k}$ would have to be calculated.
The expression for such a derivative would be similar to equation (\ref{eq:gradRi}),
but only the summand for the particular source, for which the fit parameter is for, would
contribute.


\subsection{Multiple Datasets}

With Skylab a set of $J$ different data samples (datasets) $\mathrm{D}_j$ can be
analyzed at once. Each data sample has its own detector signal efficiency
$\mathcal{Y}_{\mathrm{s},j}$.

The composite likelihood function is the product of the individual dataset
likelihood functions:
\begin{equation}
 \log \Lambda = \sum_{j=1}^{J} \log \Lambda_j
 \label{eq:logLambdaComposite}
\end{equation}

The total number of signal events $\ns$ needs to get split-up into
$n_{\mathrm{s},j}$ for the individual data samples. The distribution of $\ns$
along the different data samples is based on the detector signal efficiency
$\mathcal{Y}_{\mathrm{s},j}$ of each sample:
\begin{equation}
 n_{\mathrm{s},j}(\ns,\ps) = \ns \frac{\mathcal{Y}_{\mathrm{s},j}(\ps)}{\sum_{j=1}^{J} \mathcal{Y}_{\mathrm{s},j}(\ps)},
 \label{eq:nsjy}
\end{equation}
where $\ps$ denotes the source parameters as above and contains the source
position(s) $\xs$ and possible additional source parameters like
for instance the spectral index $\gamma$.

By defining the sample weight factor
\begin{equation}
 f_j(\ps) \equiv \frac{\mathcal{Y}_{\mathrm{s},j}(\ps)}{\sum_{j=1}^{J} \mathcal{Y}_{\mathrm{s},j}(\ps)}
\end{equation}
with the property
\begin{equation}
 \sum_{j=1}^{J} f_j = 1
\end{equation}
equation \ref{eq:nsjy} reads
\begin{equation}
 n_{\mathrm{s},j}(\ns,\ps) = \ns f_{j}(\ps)
 \label{eq:ns-sample-weight-factor}
\end{equation}

The detector signal efficiency $\mathcal{Y}_{\mathrm{s},j}(\ps)$
depends on the signal model parameters $\ps$, hence, on the source location(s) $\xs$
and the spectral index $\gamma$. It can be calculated via the detector effective
area and the source flux.

For a single point source the sample weight factor can be calculated via the effective area
$A_{\mathrm{eff},j}(E)|_{\xs}$ at the source location of each data sample, and the
differential flux $\dPhisdE$ of the source.
\begin{equation}
 f_{j}(\ps) = \frac{\int_0^\infty \mathrm{d}E A_{\mathrm{eff},j}(E|{\xs}) \dPhisdE(E,\ps)}
	           {\sum_{i=1}^{J} \int_0^\infty \mathrm{d}E A_{\mathrm{eff},i}(E|{\xs}) \dPhisdE(E,\ps)}
 \label{eq:fj}
\end{equation}

Using the sample weight factor $f_{j}(\ps)$ the likelihood ratio of
equation \eq{eq:logLambdaComposite} with equation \eq{eq:logLambdaOfX} can now
be written as
\begin{equation}
 \log \Lambda(\ns,\ps) = \sum_{j=1}^{J} \sum_{i=1}^{N} \log (1 + \ns f_{j}(\ps)\mathcal{X}_i(\ps)).
\end{equation}
From a reuseability-of-software point of view it is advisable to be able to use
the mathematical form of $\log \Lambda$ for the single dataset to calculate the
combined $\log \Lambda$ value of the multiple dataset. This can be achieved by
using the substitution of $\ns$ as given by equation (\ref{eq:ns-sample-weight-factor}).
Hence,
\begin{equation}
 \log \Lambda(\ns,\ps) = \sum_{j=1}^{J} \log \Lambda_j(n_{\mathrm{s},j}(\ns,\ps),\ps).
 \label{eq:logLambdaOfLogLambdaj}
\end{equation}

For multiple point sources, i.e. a stacking of $K$ point sources with positions
$\vec{x}_{\mathrm{s},k}$, the sample weight factor of each single source needs
to be taking into account. Thus, $f_{j}$ can be written as the sum of the
products of the sample weight factor $f_{j}(\vec{p}_{\mathrm{s},k})$ for
source $k$ and the relative strength $f_{k}(\vec{p}_{\mathrm{s},k})$ of the
$k$th source in all data samples compared to all the other sources in all data
samples.
\begin{equation}
 f_{j}(\ps) = \sum_{k=1}^{K} f_{j}(\vec{p}_{\mathrm{s},k}) f_{k}(\vec{p}_{\mathrm{s},k})
\end{equation}
The relative strength of source $k$ can be written as
\begin{equation}
 f_{k}(\vec{p}_{\mathrm{s},k}) =
    \frac{\sum_{i=1}^{J} \int_0^\infty \mathrm{d}E A_{\mathrm{eff},i}(E|\vec{x}_{\mathrm{s},k}) \dPhisdE(E,\vec{p}_{\mathrm{s},k})}
         {\sum_{\kappa=1}^{K} \sum_{i=1}^{J} \int_0^\infty \mathrm{d}E A_{\mathrm{eff},i}(E|\vec{x}_{\mathrm{s},\kappa}) \dPhisdE(E,\vec{p}_{\mathrm{s},k}) }
 \label{eq:fk}
\end{equation}
The combination of equation \ref{eq:fj} with $\ps \equiv \vec{p}_{\mathrm{s},k}$, hence,
$\xs \equiv \vec{x}_{\mathrm{s},k}$ and equation
\ref{eq:fk}, leads to the final expression for $f_{j}$ for multiple sources:
\begin{equation}
 f_{j}(\ps) =
    \frac{\sum_{k=1}^{K} \int_0^\infty \mathrm{d}E A_{\mathrm{eff},j}(E|\vec{x}_{\mathrm{s},k}) \dPhisdE(E,\vec{p}_{\mathrm{s},k}) }
         {\sum_{i=1}^{J} \sum_{k=1}^{K} \int_0^\infty \mathrm{d}E A_{\mathrm{eff},i}(E|\vec{x}_{\mathrm{s},k}) \dPhisdE(E,\vec{p}_{\mathrm{s},k}) }
 \label{eq:fjmultips}
\end{equation}
One should note that by definition the numerator of equation \eq{eq:fjmultips}
is one of the summands of the sum in the denumerator, i.e. for $i=j$.

\subsection{Gradients of the Multi-Dataset Log-Likelihood Ratio}

By using equation (\ref{eq:logLambdaOfLogLambdaj}) for the combined log-likelihood
ratio, its derivative w.r.t. $\ns$ is given by
\begin{equation}
 \frac{\mathrm{d} \log \Lambda(\ns,\ps)}{\mathrm{d} \ns} = \sum_{j=1}^{J} \frac{\mathrm{d} \log \Lambda_j(n_{\mathrm{s},j},\ps)}{\mathrm{d} n_{\mathrm{s},j}} \frac{\mathrm{d} n_{\mathrm{s},j}}{\mathrm{d} \ns},
\end{equation}
with
\begin{equation}
\frac{\mathrm{d} n_{\mathrm{s},j}}{\mathrm{d} \ns} = f_j(\ps).
\end{equation}
The derivative w.r.t. the single source fit parameter, $p_{\mathrm{s}}$, consists
of the partial derivatives of $\log \Lambda_j$ w.r.t. $n_{\mathrm{s},j}$ and
$p_{\mathrm{s}}$:
\begin{equation}
 \frac{\mathrm{d} \log \Lambda(\ns,\ps)}{\mathrm{d} p_{\mathrm{s}}} = \sum_{j=1}^{J} \frac{\partial \log \Lambda_j(\nsj,\ps)}{\partial \nsj} \frac{\mathrm{d} \nsj}{\mathrm{d} p_{\mathrm{s}}} + \frac{\partial \log \Lambda_j(\nsj,\ps)}{\partial p_{\mathrm{s}}},
\end{equation}
with
\begin{equation}
 \frac{\mathrm{d} \nsj}{\mathrm{d} p_{\mathrm{s}}} = \ns \frac{\mathrm{d} f_j(\ps)}{\mathrm{d} p_{\mathrm{s}}}.
\end{equation}


\section{Detector Signal Efficiency}

The detector signal efficiency $\mathcal{Y}_{\mathrm{s},j}(\psk)$
of a data sample $j$ for a source $k$ is defined as the integral over the energy
of the product of the detector effective area and the differential flux
$\frac{\mathrm{d}\Phi_{\mathrm{s}}}{\mathrm{d}E}$ of the source:
\begin{equation}
 \mathcal{Y}_{\mathrm{s},j}(\xsk,\psk) \equiv \int_0^\infty \mathrm{d}E A_{\mathrm{eff},j}(E|\xsk) \frac{\mathrm{d}\Phi_{\mathrm{s}}}{\mathrm{d}E}(E|\psk) T_{\mathrm{live},j}
\label{eq:Ysj}
\end{equation}
It is the mean number of signal events per steradian expected from a source at
position $\xs$ with source parameters $\ps$. In the most-general case,
the source position $\xs$ consists of three quantities: right-ascention,
declination, and observation time, i.e.
$\xs = (\alpha_{\mathrm{s}},\delta_{\mathrm{s}},t_{\mathrm{obs}})$.

\subsection{Effective Area}

In Skylab the effective area $A_{\mathrm{eff},j}$ of a data sample $j$ is not
calculated separately in order to avoid binning effects. However, the effective
area can be calculated using the monte-carlo weights \code{mcweight}\footnote{In IceCube
known as ``OneWeight'', but which already includes the number of used MC files.}
of the simulation events.
The monte-carlo weights have the unit GeV~cm$^2$~sr.
Using the monte-carlo weight, $w_{m,j}$, of the $m$th event of data sample $j$
the effective area is given by the sum over the event weights divided by the
solid angle and the energy range $\Delta E$ of the summed selected events:
\begin{equation}
 A_{\mathrm{eff},j}(E) = \frac{\sum_{m=1}^{M} w_{m,j}}{\Omega \Delta E}
\end{equation}


\subsection{The DetectorSignalEfficiency Class}

\class{DetectorSignalEfficiency} provides a detector signal efficiency class to
compute the integral given in equation \eq{eq:Ysj}. The detector signal
efficiency depends on the flux model and its source parameters, which might
change during the likelihood maximization process. It is also dependent on the
detector effective area, hence is detector dependent. Thus,
\class{DetectorSignalEfficiency} must be provided with a detector signal
efficiency implementation method derived from the \class{DetSigEffImplMethod}
class.

Detector signal efficiency values can be retrieved via the call operator
\code{\_\_call\_\_(src\_pos src\_params)}, which takes the celestrial position
of the source and the additional source parameters as arguments.

\subsubsection{The DetSigEffImplMethod Class}

\class{DetSigEffImplMethod} is an abstract base class and defines the interface
between the detector signal efficiency implementation method and the
\class{DetectorSignalEfficiency} class.

% List of detector signal efficiency implementation methods.
Table \ref{tbl:I3DetSigEffImplMethod} lists all available IceCube specific
detector signal efficiency implementation methods and their description.
\begin{table}
\caption{IceCube specific detector signal efficiency implementation methods.}
\label{tbl:I3DetSigEffImplMethod}

\begin{tabular}{l | p{10cm}}
\hline
Name of Class & Description \\
\hline
I3FixedFluxDetSigEff & IceCube detector signal efficiency implementation method for a
    fixed flux model, which might contain flux parameters, but which
    are not fit in the likelihood maximization process.
    This implementation assumes that the detector effective
    area depends solely on the declination of the source. This method creates
    a spline function of given order for the logarithmic values of the
    $\sin(\delta)$-dependent detector signal efficiency.

    The constructor of this implementation method requires a $\sin(\delta)$
    binning definition for the monte-carlo events and the order of the spline
    function.\\
I3PowerLawFluxDetSigEff & IceCube detector signal efficiency implementation method for a
    power law flux model, implemented by the \class{PowerLawFlux} class.
    This method creates a 2D spline function of given orders for the logarithmic
    values of the $\sin(\delta)$-dependent detector signal efficiency for a
    range of $\gamma$ values. This implementation method supports
    multi-processing.
\end{tabular}
\end{table}



\section{Implemented Log-Likelihood Models}
This section describes the implemented log-likelihood models. \cite{TimeDepPSSearchMethods2010}

% \subsection{Time Dependent Point-Source Flare}
%
% The \class{TimeDepPSFlareLHModel} class provides the likelihood model for searching for a point source with unknown time-dependence.
% The search is based on the formulism described in \cite{TimeDepPSSearchMethods2010}.
%
% The model utilizes a two-component likelihood function with signal and background events.

\bibliographystyle{unsrt}
\bibliography{biblio}

\end{document}
